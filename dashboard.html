<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Prenotazioni</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --colore-primario: #007BFF;
            --colore-primario-trasparente: rgba(0, 123, 255, 0.1);
            --colore-accento: #DC3545;
            --colore-successo: #28a745;
            --colore-ricorrente: #6f42c1; /* Viola per prenotazioni ricorrenti */
            --colore-sfondo: #F4F7FC;
            --colore-superficie: #FFFFFF;
            --colore-bordo: #E9ECEF;
            --colore-testo-principale: #212529;
            --colore-testo-secondario: #6C757D;
        }
        body { font-family: 'Noto Sans', sans-serif; background-color: var(--colore-sfondo); color: var(--colore-testo-principale); margin: 0; }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }
        h1, h2, h3 { font-family: 'Plus Jakarta Sans', sans-serif; }
        .date-navigation { display: flex; justify-content: space-between; align-items: center; gap: 15px; background-color: var(--colore-superficie); padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .date-navigation button { background: none; border: 1px solid var(--colore-bordo); color: var(--colore-primario); padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .date-navigation button:hover { background-color: var(--colore-primario); color: white; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); }
        .date-navigation #today-btn { color: var(--colore-successo); }
        .date-navigation #today-btn:hover { background-color: var(--colore-successo); color: white; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2); }
        .date-navigation h2 { color: var(--colore-primario); font-size: 1.8rem; margin: 0; text-align: center; flex-grow: 1; }
        
        .column-headers { display: grid; grid-template-columns: 80px repeat(3, 1fr); gap: 2px; margin-bottom: -2px; padding: 0; font-weight: bold; text-align: center; }
        .header-item { background-color: #343A40; color: white; padding: 15px; border-radius: 6px 6px 0 0; }
        .header-item:first-child { background-color: transparent; color: transparent; }

        .calendar-container { display: grid; grid-template-columns: 80px repeat(3, 1fr); gap: 2px; background-color: var(--colore-bordo); border: 1px solid var(--colore-bordo); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .time-label { grid-column: 1 / 2; text-align: center; font-size: 0.9rem; font-weight: bold; color: var(--colore-testo-secondario); background-color: #F8F9FA; display: flex; align-items: center; justify-content: center; border-top: 1px solid var(--colore-bordo); }
        .time-slot { position: relative; background-color: var(--colore-superficie); min-height: 100px; border-top: 1px solid var(--colore-bordo); transition: background-color 0.2s; }

        .booking-card.paid { background-color: var(--colore-successo); }
        .booking-card.unpaid { background-color: var(--colore-accento); }
        .booking-card .booking-card-content { cursor: pointer; }
        .booking-card p.booking-notes { font-style: italic; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; margin-top: 5px; white-space: pre-wrap; }
        
        .time-slot.empty { cursor: pointer; }
        .time-slot.empty:hover { background-color: var(--colore-primario-trasparente); }
        .time-slot.empty::after {
            content: '\f067'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: var(--colore-primario); opacity: 0; transition: opacity 0.2s;
        }
        .time-slot.empty:hover::after { opacity: 0.5; }

        .booking-card { position: absolute; top: 3px; bottom: 3px; left: 3px; right: 3px; background-color: var(--colore-primario); color: white; padding: 8px; border-radius: 6px; font-size: 0.85rem; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5; display: flex; flex-direction: column; transition: all 0.3s ease; }
        .booking-card.recurring { background-color: var(--colore-ricorrente); cursor: default; }
        .booking-card-content { flex-grow: 1; }
        .booking-card strong { display: block; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 4px; margin-bottom: 4px; }
        .booking-card p { margin: 2px 0; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }
        .booking-card .recurring-icon { font-size: 0.7rem; opacity: 0.8; }
        .delete-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.2); border: none; color: white; cursor: pointer; font-size: 0.8rem; opacity: 0.6; transition: all 0.2s; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .delete-btn:hover { opacity: 1; color: white; background-color: var(--colore-accento); transform: scale(1.1); }
        
        .loading-indicator, #no-bookings { text-align: center; font-size: 1.2rem; padding: 50px; color: var(--colore-testo-secondario); }
        #no-bookings { display: none; }

        .recurring-bookings-panel { margin-top: 40px; padding: 25px; background-color: var(--colore-superficie); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .recurring-bookings-panel h2 { margin-top: 0; border-bottom: 1px solid var(--colore-bordo); padding-bottom: 15px; margin-bottom: 20px; }
        .recurring-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        #recurring-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 500; color: var(--colore-testo-secondario); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border-radius: 6px; border: 1px solid var(--colore-bordo); font-size: 1rem; font-family: 'Noto Sans', sans-serif; }
        #recurring-form button { background-color: var(--colore-ricorrente); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        #recurring-form button:hover { background-color: #5a329a; }
        
        #recurring-list ul { list-style: none; padding: 0; margin: 0; }
        #recurring-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: var(--colore-sfondo); border-radius: 6px; margin-bottom: 8px; }
        #recurring-list .delete-recurring-btn { background-color: var(--colore-accento); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }

        /* NUOVE REGOLE PER LA LISTA RICORRENTI A FISARMONICA */
        .recurring-day-header {
            background-color: #e9ecef;
            color: var(--colore-testo-principale);
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background-color 0.3s ease;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recurring-day-header:hover, .recurring-day-header.active {
            background-color: #d3d9df;
        }

        .recurring-day-header::after {
            content: '\f078'; /* Icona freccia gi√π di Font Awesome */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--colore-testo-secondario);
            transition: transform 0.3s ease;
        }

        .recurring-day-header.active::after {
            transform: rotate(-180deg);
        }

        .recurring-day-content {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e9ecef;
            border-top: none;
        }

        .recurring-day-content ul {
            padding: 10px 0;
        }
        /* FINE NUOVE REGOLE */

        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--colore-superficie); padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; position: relative; }
        .modal-content h2 { margin-top: 0; }
        .modal-content .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-content .close-btn:hover { color: #333; }
        #manual-booking-form, #edit-booking-form { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Prenotazioni</h1>
        <div class="date-navigation">
            <button id="prev-day"><i class="fa-solid fa-chevron-left"></i> Precedente</button>
            <button id="today-btn"><i class="fa-solid fa-calendar-day"></i> Oggi</button>
            <h2 id="current-date">Caricamento...</h2>
            <button id="next-day">Successivo <i class="fa-solid fa-chevron-right"></i></button>
        </div>
        
        <div class="column-headers">
            <div class="header-item">Orario</div>
            <div class="header-item">Campo 1</div>
            <div class="header-item">Campo 2</div>
            <div class="header-item">Campo 3</div>
        </div>

        <div id="calendar-grid" class="calendar-container"></div>
        <div id="loading" class="loading-indicator"><i class="fa-solid fa-spinner fa-spin"></i> Caricamento prenotazioni...</div>
        <div id="no-bookings">Nessuna prenotazione per questa data.</div>
    </div>

    <div class="container">
        <div class="recurring-bookings-panel">
            <h2>Gestione Prenotazioni Ricorrenti</h2>
            <div class="recurring-layout">
                <div id="recurring-form-container">
                    <h3>Aggiungi / Blocca Periodo</h3>
                    <form id="recurring-form">
                        <div class="form-group"><label for="recurring-name">Nome (es. Corso Adulti, Blocco Campo)</label><input type="text" id="recurring-name" placeholder="Nome della prenotazione" required></div>
                        <div class="form-group"><label for="recurring-day">Giorno della settimana</label><select id="recurring-day" required><option value="1">Luned√¨</option><option value="2">Marted√¨</option><option value="3">Mercoled√¨</option><option value="4">Gioved√¨</option><option value="5">Venerd√¨</option><option value="6">Sabato</option><option value="0">Domenica</option></select></div>
                        <div class="form-group"><label for="recurring-field">Campo</label><select id="recurring-field" required><option value="1">Campo 1</option><option value="2">Campo 2</option><option value="3">Campo 3</option></select></div>
                        <div class="form-group"><label for="recurring-time-start">Orario Inizio</label><select id="recurring-time-start" required></select></div>
                        <div class="form-group"><label for="recurring-time-end">Orario Fine (per blocchi di pi√π ore)</label><select id="recurring-time-end"><option value="">Singola Ora</option></select></div>
                        <button type="submit">Aggiungi Ricorrente</button>
                    </form>
                </div>
                <div id="recurring-list-container">
                    <h3>Prenotazioni Attive</h3>
                    <div id="recurring-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale per nuova prenotazione -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Aggiungi Prenotazione</h2>
            <form id="manual-booking-form">
                <input type="hidden" id="manual-field"><input type="hidden" id="manual-time">
                <div class="form-group"><label for="manual-name">Nome</label><input type="text" id="manual-name" required></div>
                <div class="form-group"><label for="manual-surname">Cognome</label><input type="text" id="manual-surname" required></div>
                <div class="form-group"><label for="manual-email">Email</label><input type="email" id="manual-email" required></div>
                <div class="form-group"><label for="manual-phone">Telefono</label><input type="tel" id="manual-phone" required></div>
                <button type="button" id="fill-placeholder-data" style="width: 100%; background-color: var(--colore-testo-secondario); color: white; padding: 8px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px;"><i class="fa-solid fa-user-check"></i> Usa dati generici (cliente senza email)</button>
                <button type="submit" class="submit-btn" style="width: 100%; background-color: var(--colore-successo); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">Salva Prenotazione</button>
            </form>
        </div>
    </div>

    <!-- Modale per modifica prenotazione -->
    <div id="edit-booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="edit-modal-title">Modifica Prenotazione</h2>
            <div id="edit-modal-subtitle" style="color: var(--colore-testo-secondario); margin-bottom: 20px;"></div>
            <form id="edit-booking-form">
                 <div class="form-group">
                    <label for="edit-payment-status">Stato Pagamento</label>
                    <select id="edit-payment-status">
                        <option value="unpaid">Non Pagato</option>
                        <option value="paid">Pagato</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-notes">Note</label>
                    <textarea id="edit-notes" rows="4" placeholder="Aggiungi note sulla prenotazione..."></textarea>
                </div>
                <button type="submit" class="submit-btn" style="width: 100%; background-color: var(--colore-primario); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">Salva Modifiche</button>
            </form>
        </div>
    </div>

    <!-- Modale per la cancellazione con causale -->
    <div id="cancellation-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Conferma Cancellazione</h2>
            <p id="cancellation-info" style="color: var(--colore-testo-secondario); margin-bottom: 20px;"></p>
            <form id="cancellation-form">
                <div class="form-group">
                    <label for="cancellation-reason">Causale della cancellazione (verr√† inviata al cliente)</label>
                    <textarea id="cancellation-reason" rows="4" placeholder="Es. Manutenzione campo, pioggia, ecc..." required></textarea>
                </div>
                <button type="submit" class="submit-btn" style="width: 100%; background-color: var(--colore-accento); color: white; padding: 12px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;">Cancella e Invia Notifica</button>
            </form>
        </div>
    </div>

    <!-- Modale generico per le notifiche -->
    <div id="notification-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-btn">&times;</span>
            <div id="notification-icon" style="font-size: 40px; margin-bottom: 15px;"></div>
            <p id="notification-message" style="font-size: 1.1rem;"></p>
        </div>
    </div>

    <!-- Modale generico di conferma -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <span class="close-btn">&times;</span>
            <h2 id="confirm-title">Conferma Azione</h2>
            <p id="confirm-message" style="color: var(--colore-testo-secondario); margin-bottom: 20px;"></p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="confirm-cancel-btn" type="button" style="background-color: var(--colore-testo-secondario); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Annulla</button>
                <button id="confirm-action-btn" type="button" style="background-color: var(--colore-accento); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Conferma</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyCxetNrmEOQJYwunOo-OQddzCMfP7DEtIU",
            authDomain: "ct-tricase.firebaseapp.com",
            databaseURL: "https://ct-tricase-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ct-tricase",
            storageBucket: "ct-tricase.appspot.com",
            messagingSenderId: "931504527474",
            appId: "1:931504527474:web:165880ec30f3785ff54aeb",
            measurementId: "G-7M4D22L352"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Riferimenti agli elementi DOM
        const prevDayBtn = document.getElementById('prev-day');
        const nextDayBtn = document.getElementById('next-day');
        const todayBtn = document.getElementById('today-btn');
        const currentDateElem = document.getElementById('current-date');
        const calendarGrid = document.getElementById('calendar-grid');
        const loadingIndicator = document.getElementById('loading');
        const noBookingsMsg = document.getElementById('no-bookings');
        
        const recurringForm = document.getElementById('recurring-form');
        const recurringListDiv = document.getElementById('recurring-list');
        const recurringFieldSelect = document.getElementById('recurring-field');
        const recurringTimeStartSelect = document.getElementById('recurring-time-start');
        const recurringTimeEndSelect = document.getElementById('recurring-time-end');

        // Modali
        const bookingModal = document.getElementById('booking-modal');
        const editBookingModal = document.getElementById('edit-booking-modal');
        const cancellationModal = document.getElementById('cancellation-modal');
        const notificationModal = document.getElementById('notification-modal');
        const confirmModal = document.getElementById('confirm-modal');
        
        const manualBookingForm = document.getElementById('manual-booking-form');
        const editBookingForm = document.getElementById('edit-booking-form');
        const cancellationForm = document.getElementById('cancellation-form');

        let currentDate = new Date();
        let currentBookingsListener = null;
        let recurringBookings = {};

        function showNotification(message, isError = false) {
            const iconDiv = document.getElementById('notification-icon');
            const messageP = document.getElementById('notification-message');
            messageP.textContent = message;
            if (isError) {
                iconDiv.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color: var(--colore-accento);"></i>';
            } else {
                iconDiv.innerHTML = '<i class="fa-solid fa-circle-check" style="color: var(--colore-successo);"></i>';
            }
            notificationModal.style.display = 'flex';
        }

        const renderCalendar = (dayBookings = {}) => {
            calendarGrid.innerHTML = '';
            loadingIndicator.style.display = 'none';
            
            const currentDayOfWeek = currentDate.getDay();
            for (const id in recurringBookings) {
                const rb = recurringBookings[id];
                if (parseInt(rb.giornoSettimana) === currentDayOfWeek) {
                    const fieldId = `campo-${rb.campo}`;
                    const timeKey = rb.orario.replace(':', '-');
                    if (!dayBookings[fieldId]) dayBookings[fieldId] = {};
                    if (!dayBookings[fieldId][timeKey]) {
                        dayBookings[fieldId][timeKey] = {
                            nome: rb.nome, cognome: '(Ricorrente)', telefono: 'N/A',
                            email: 'N/A', isRecurring: true,
                        };
                    }
                }
            }
            
            noBookingsMsg.style.display = Object.keys(dayBookings).length === 0 ? 'block' : 'none';

            const fragment = document.createDocumentFragment();
            const slots = {}; 

            for (let hour = 8; hour < 22; hour++) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = `${String(hour).padStart(2, '0')}:00`;
                fragment.appendChild(timeLabel);
                for (let field = 1; field <= 3; field++) {
                    const slotId = `slot-${hour}-${field}`;
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.id = slotId;
                    slots[slotId] = slotDiv; 
                    fragment.appendChild(slotDiv);
                }
            }

            for (const fieldId in dayBookings) {
                const fieldBookings = dayBookings[fieldId];
                const fieldNumber = fieldId.split('-')[1];

                for (const time in fieldBookings) {
                    const booking = fieldBookings[time];
                    if (!booking) continue;
                    const [startHour] = time.replace('-',':').split(':').map(Number);
                    const targetSlotId = `slot-${startHour}-${fieldNumber}`;
                    const targetSlot = slots[targetSlotId];
                    
                    if (targetSlot) {
                        const card = document.createElement('div');
                        card.className = 'booking-card';
                        
                        if (booking.isRecurring) {
                            card.classList.add('recurring');
                        } else {
                            card.classList.add(booking.pagato ? 'paid' : 'unpaid');
                        }
                        
                        let deleteButtonHTML = '';
                        if (!booking.isRecurring) {
                            deleteButtonHTML = `<button class="delete-btn" data-field="${fieldId}" data-time="${time.replace(':', '-')}" data-booking-id="${booking.bookingId || ''}" title="Cancella prenotazione"><i class="fa-solid fa-trash-can"></i></button>`;
                        }

                        card.innerHTML = `
                            ${deleteButtonHTML}
                            <div class="booking-card-content" data-field="${fieldId}" data-time="${time}">
                                <strong>${booking.nome || 'N/A'} ${booking.cognome || ''}</strong>
                                <p><i class="fa-solid fa-clock fa-fw"></i> ${time.replace('-',':')} ${booking.isRecurring ? '<i class="fa-solid fa-sync recurring-icon" title="Ricorrente"></i>' : ''}</p>
                                <p><i class="fa-solid fa-phone fa-fw"></i> ${booking.telefono || '-'}</p>
                                <p><i class="fa-solid fa-envelope fa-fw"></i> ${booking.email || '-'}</p>
                                ${booking.note ? `<p class="booking-notes"><i class="fa-solid fa-note-sticky fa-fw"></i> ${booking.note}</p>` : ''}
                            </div>`;
                        
                        targetSlot.appendChild(card);
                    }
                }
            }

            Object.values(slots).forEach(slot => {
                if (slot.childElementCount === 0) {
                    slot.classList.add('empty');
                    const [, hour, field] = slot.id.split('-');
                    let minutes = '00';
                    if (field === '2') minutes = '15';
                    else if (field === '3') minutes = '30';
                    const timeString = `${String(hour).padStart(2, '0')}:${minutes}`;
                    
                    slot.dataset.time = timeString;
                    slot.dataset.field = field;
                }
            });

            calendarGrid.appendChild(fragment);
        };

        const listenToBookingsForDate = () => {
            if (currentBookingsListener) { currentBookingsListener.off(); }
            loadingIndicator.style.display = 'block';
            calendarGrid.innerHTML = '';
            noBookingsMsg.style.display = 'none';
            currentDateElem.textContent = new Intl.DateTimeFormat('it-IT', { dateStyle: 'full' }).format(currentDate);
            
            const dateString = currentDate.toISOString().split('T')[0];
            const bookingsRef = database.ref('prenotazioni/' + dateString);
            currentBookingsListener = bookingsRef;
            
            bookingsRef.on('value', (snapshot) => {
                const bookings = snapshot.val() || {};
                renderCalendar(bookings);
            }, (error) => {
                console.error("Errore di Firebase:", error);
                showNotification("Errore nel caricamento dei dati.", true);
            });
        };

        // Funzione per la pulizia delle prenotazioni 'pending' scadute
        const cleanupPendingBookings = async () => {
            console.log("Esecuzione della pulizia delle prenotazioni in attesa...");
            const now = Date.now();
            // 5 minuti in millisecondi
            const timeout = 5 * 60 * 1000; 

            // Ottiene un riferimento a tutte le prenotazioni nell'indice
            const indexRef = database.ref('indicePrenotazioni');
            const snapshot = await indexRef.once('value');

            if (snapshot.exists()) {
                const bookingsData = snapshot.val();
                
                // Itera su tutte le prenotazioni dell'indice
                for (const bookingId in bookingsData) {
                    const bookingEntry = bookingsData[bookingId];
                    if (bookingEntry.status === 'pending') {
                        // Calcola il tempo trascorso dalla creazione
                        const timeElapsed = now - bookingEntry.prenotatoIl;

                        // Se la prenotazione √® pi√π vecchia del timeout, la cancella
                        if (timeElapsed > timeout) {
                            console.log(`Cancellazione prenotazione scaduta: ${bookingId}`);
                            
                            // Cancella l'entry dall'indice
                            await indexRef.child(bookingId).remove();

                            // Cancella gli slot di tempo dal calendario principale
                            const { data, campo, orari } = bookingEntry;
                            if (data && campo && orari) {
                                const bookingsRef = database.ref(`prenotazioni/${data}/campo-${campo}`);
                                const updates = {};
                                orari.forEach(time => {
                                    updates[time.replace(':', '-')] = null;
                                });
                                await bookingsRef.update(updates);
                                console.log(`Cancellati gli slot per la prenotazione ${bookingId} nel campo ${campo} del ${data}.`);
                            }
                        }
                    }
                }
            }
        };

        // Avvia l'esecuzione periodica della funzione di pulizia
        const cleanupInterval = setInterval(() => {
            cleanupPendingBookings().catch(err => {
                console.error("Errore durante la pulizia periodica:", err);
            });
        }, 10000); // Esegue la pulizia ogni 10 secondi (10000 ms)

        // Interrompe l'intervallo quando l'utente naviga via dalla pagina
        window.addEventListener('beforeunload', () => {
            clearInterval(cleanupInterval);
        });

        const listenToRecurringBookings = () => {
            const recurringRef = database.ref('prenotazioniRicorrenti');
            recurringRef.on('value', (snapshot) => {
                recurringBookings = snapshot.val() || {};
                renderRecurringList();
                listenToBookingsForDate(); 
            });
        };
        
        // MODIFICATA: renderRecurringList per creare una fisarmonica
        const renderRecurringList = () => {
            recurringListDiv.innerHTML = '';
            if (Object.keys(recurringBookings).length === 0) {
                recurringListDiv.innerHTML = '<p>Nessuna prenotazione ricorrente impostata.</p>';
                return;
            }

            const bookingsByDay = {};
            for (const id in recurringBookings) {
                const booking = recurringBookings[id];
                booking.id = id; // Aggiungo l'id all'oggetto per un facile accesso
                const day = booking.giornoSettimana;
                if (!bookingsByDay[day]) {
                    bookingsByDay[day] = [];
                }
                bookingsByDay[day].push(booking);
            }

            const days = ["Domenica", "Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato"];
            const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Ordine da Luned√¨ a Domenica

            for (const dayIndex of dayOrder) {
                if (bookingsByDay[dayIndex]) {
                    const dayName = days[dayIndex];
                    const dayBookings = bookingsByDay[dayIndex];

                    const header = document.createElement('button');
                    header.className = 'recurring-day-header';
                    header.innerHTML = `<span>${dayName}</span> <span style="font-weight:normal; color: var(--colore-testo-secondario); font-size: 0.9rem;">${dayBookings.length} prenotazioni</span>`;
                    
                    const content = document.createElement('div');
                    content.className = 'recurring-day-content';
                    
                    const ul = document.createElement('ul');
                    // Ordina le prenotazioni per orario
                    dayBookings.sort((a, b) => a.orario.localeCompare(b.orario));

                    for (const rb of dayBookings) {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span><strong>${rb.nome}</strong> - ore ${rb.orario}, Campo ${rb.campo}</span>
                            <button class="delete-recurring-btn" data-id="${rb.id}" title="Cancella ricorrente"><i class="fa-solid fa-trash-can"></i></button>
                        `;
                        ul.appendChild(li);
                    }
                    
                    content.appendChild(ul);
                    recurringListDiv.appendChild(header);
                    recurringListDiv.appendChild(content);
                }
            }
        };

        calendarGrid.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            const emptySlot = e.target.closest('.time-slot.empty');
            const editTrigger = e.target.closest('.booking-card-content');

            if (deleteBtn) {
                const { field, time, bookingId } = deleteBtn.dataset;
                const dateString = currentDate.toISOString().split('T')[0];
                const bookingPath = `prenotazioni/${dateString}/${field}/${time}`;

                const bookingRef = database.ref(bookingPath);
                bookingRef.once('value', (snapshot) => {
                    const bookingData = snapshot.val();
                    if (!bookingData) {
                        showNotification('Impossibile trovare i dati della prenotazione da cancellare.', true);
                        return;
                    }
                    
                    document.getElementById('cancellation-info').textContent = `Stai per cancellare la prenotazione di ${bookingData.nome} ${bookingData.cognome} per le ore ${time.replace('-',':')}.`;
                    
                    const form = document.getElementById('cancellation-form');
                    form.reset();
                    form.dataset.bookingPath = bookingPath;
                    form.dataset.indexPath = `indicePrenotazioni/${bookingId}`;
                    form.dataset.bookingId = bookingId;
                    form.dataset.userEmail = bookingData.email;
                    form.dataset.userName = bookingData.nome;
                    form.dataset.bookingDate = new Date(dateString).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    form.dataset.bookingTime = time.replace('-',':');
                    
                    cancellationModal.style.display = 'flex';
                });

            } else if (emptySlot) {
                const { time, field } = emptySlot.dataset;
                document.getElementById('modal-title').textContent = `Aggiungi Prenotazione - Campo ${field} ore ${time}`;
                manualBookingForm.reset();
                document.getElementById('manual-field').value = field;
                document.getElementById('manual-time').value = time;
                bookingModal.style.display = 'flex';
            
            } else if (editTrigger && !editTrigger.closest('.booking-card.recurring')) {
                const { field, time } = editTrigger.dataset;
                const dateString = currentDate.toISOString().split('T')[0];
                const bookingPath = `prenotazioni/${dateString}/${field}/${time}`;

                const bookingRef = database.ref(bookingPath);
                bookingRef.once('value', (snapshot) => {
                    const bookingData = snapshot.val();
                    if (!bookingData) return;

                    const fieldNumber = field.split('-')[1];
                    const timeFormatted = time.replace('-', ':');
                    
                    document.getElementById('edit-modal-subtitle').textContent = `${bookingData.nome} ${bookingData.cognome} - Campo ${fieldNumber} ore ${timeFormatted}`;
                    
                    document.getElementById('edit-payment-status').value = bookingData.pagato ? 'paid' : 'unpaid';
                    document.getElementById('edit-notes').value = bookingData.note || '';
                    
                    editBookingForm.dataset.bookingPath = bookingPath;
                    editBookingModal.style.display = 'flex';
                });
            }
        });
        
        prevDayBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); listenToBookingsForDate(); });
        nextDayBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); listenToBookingsForDate(); });
        todayBtn.addEventListener('click', () => { currentDate = new Date(); listenToBookingsForDate(); });

        function populateRecurringTimes() {
            const field = recurringFieldSelect.value;
            let minutes;
            if (field === '1') minutes = '00';
            else if (field === '2') minutes = '15';
            else if (field === '3') minutes = '30';
            else minutes = '00';

            recurringTimeStartSelect.innerHTML = '';
            recurringTimeEndSelect.innerHTML = '<option value="">Singola Ora</option>';

            for (let hour = 8; hour < 22; hour++) {
                const timeString = `${String(hour).padStart(2, '0')}:${minutes}`;
                recurringTimeStartSelect.add(new Option(timeString, timeString));
                recurringTimeEndSelect.add(new Option(timeString, timeString));
            }
        }
        recurringFieldSelect.addEventListener('change', populateRecurringTimes);

        recurringForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const submitBtn = recurringForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const name = document.getElementById('recurring-name').value.trim();
            const dayOfWeek = document.getElementById('recurring-day').value;
            const field = document.getElementById('recurring-field').value;
            const startTime = document.getElementById('recurring-time-start').value;
            const endTime = document.getElementById('recurring-time-end').value;

            const updates = {};
            const startHour = parseInt(startTime.split(':')[0]);
            const minutes = startTime.split(':')[1];
            const endHour = endTime ? parseInt(endTime.split(':')[0]) : startHour + 1;

            if (endTime && startHour >= endHour) {
                showNotification("L'orario di fine deve essere successivo a quello di inizio.", true);
                submitBtn.disabled = false;
                return;
            }

            for (let hour = startHour; hour < endHour; hour++) {
                const time = `${String(hour).padStart(2, '0')}:${minutes}`;
                const newRecurringBooking = {
                    giornoSettimana: dayOfWeek,
                    orario: time,
                    campo: field,
                    nome: name,
                    email: 'ricorrente@cttricase.it',
                    telefono: '000-0000000'
                };
                const newKey = database.ref('prenotazioniRicorrenti').push().key;
                updates[`/prenotazioniRicorrenti/${newKey}`] = newRecurringBooking;
            }
            
            database.ref().update(updates)
                .then(() => {
                    recurringForm.reset();
                    populateRecurringTimes();
                    showNotification('Prenotazione/i ricorrente aggiunta con successo!');
                })
                .catch(err => showNotification('Errore: ' + err.message, true))
                .finally(() => submitBtn.disabled = false);
        });

        // MODIFICATO: Listener unico per la lista ricorrenti (fisarmonica + cancellazione)
        recurringListDiv.addEventListener('click', (e) => {
            const header = e.target.closest('.recurring-day-header');
            if (header) {
                header.classList.toggle('active');
                const content = header.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
                return;
            }

            const deleteBtn = e.target.closest('.delete-recurring-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                
                document.getElementById('confirm-title').textContent = 'Cancella Ricorrenza';
                document.getElementById('confirm-message').textContent = 'Sei sicuro di voler cancellare questa prenotazione ricorrente? L\'azione √® irreversibile.';
                
                const confirmActionBtn = document.getElementById('confirm-action-btn');
                
                const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
                confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);

                const handleConfirm = () => {
                    database.ref(`prenotazioniRicorrenti/${id}`).remove()
                        .then(() => showNotification('Ricorrenza cancellata.'))
                        .catch(err => showNotification('Errore: ' + err.message, true));
                    confirmModal.style.display = 'none';
                };
                
                newConfirmActionBtn.addEventListener('click', handleConfirm);
                
                confirmModal.style.display = 'flex';
            }
        });


        // Gestione chiusura modali
        [bookingModal, editBookingModal, cancellationModal, notificationModal, confirmModal].forEach(modal => {
            modal.querySelector('.close-btn').addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });
        
        document.getElementById('fill-placeholder-data').addEventListener('click', () => {
            document.getElementById('manual-email').value = 'cliente@interno.it';
            document.getElementById('manual-phone').value = '0000000000';
        });
        
        manualBookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = manualBookingForm.querySelector('.submit-btn');
            submitBtn.disabled = true;

            const field = document.getElementById('manual-field').value;
            const time = document.getElementById('manual-time').value;
            const dateString = currentDate.toISOString().split('T')[0];
            
            const bookingRef = database.ref(`prenotazioni/${dateString}/campo-${field}`);
            const bookingId = bookingRef.push().key;

            const bookingData = {
                bookingId: bookingId,
                nome: document.getElementById('manual-name').value.trim(),
                cognome: document.getElementById('manual-surname').value.trim(),
                email: document.getElementById('manual-email').value.trim(),
                telefono: document.getElementById('manual-phone').value.trim(),
                prenotatoIl: firebase.database.ServerValue.TIMESTAMP,
                pagato: false, note: ''
            };

            const timeKey = time.replace(':', '-');
            const bookingPath = `prenotazioni/${dateString}/campo-${field}/${timeKey}`;
            const indexPath = `indicePrenotazioni/${bookingId}`;
            
            const updates = {};
            updates[bookingPath] = bookingData;
            updates[indexPath] = {
                data: dateString, campo: field, orari: [time],
                nome: bookingData.nome, cognome: bookingData.cognome,
                email: bookingData.email, prenotatoIl: bookingData.prenotatoIl
            };

            try {
                await database.ref().update(updates);
                
                const CANCELLATION_PAGE_URL = "cancella.html"; 
                const cancellationLink = `https://garrati-0.github.io/circolo-tennis-tricase/${CANCELLATION_PAGE_URL}?id=${bookingId}`;
                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbye8eB2g7m1OwRko81Qv849e4DeBZ5uH9aXEpuVO79JWT8ZXzt8EHGNf316pNBVeqt5/exec";
                const emailData = {
                    type: 'confirmation',
                    nome: bookingData.nome, email: bookingData.email,
                    data: new Date(dateString).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    campo: field, orari: time, id: bookingId, linkCancellazione: cancellationLink
                };
                
                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(emailData), headers: { 'Content-Type': 'application/json' } })
                    .then(() => console.log("Richiesta di invio email di conferma partita."))
                    .catch(error => console.error("Errore script:", error));

                showNotification('Prenotazione salvata e email inviata!');
                bookingModal.style.display = 'none';

            } catch (error) {
                showNotification('Errore nel salvataggio: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
            }
        });

        editBookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = editBookingForm.querySelector('.submit-btn');
            submitBtn.disabled = true;

            const bookingPath = editBookingForm.dataset.bookingPath;
            if (!bookingPath) {
                showNotification('Errore: percorso del booking non trovato.', true);
                submitBtn.disabled = false; return;
            }

            const updates = {
                pagato: document.getElementById('edit-payment-status').value === 'paid',
                note: document.getElementById('edit-notes').value.trim()
            };

            try {
                await database.ref(bookingPath).update(updates);
                showNotification('Modifiche salvate con successo!');
                editBookingModal.style.display = 'none';
            } catch (error) {
                showNotification('Errore salvataggio modifiche: ' + error.message, true);
            } finally {
                submitBtn.disabled = false;
            }
        });

        cancellationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = cancellationForm.querySelector('.submit-btn');
            submitBtn.disabled = true;

            const { bookingPath, indexPath, bookingId, userEmail, userName, bookingDate, bookingTime } = e.target.dataset;
            const reason = document.getElementById('cancellation-reason').value.trim();

            const indexRef = database.ref(indexPath);
            try {
                const indexSnapshot = await indexRef.once('value');
                const indexData = indexSnapshot.val();
                
                const updates = {};
                updates[bookingPath] = null;

                if (indexData && indexData.orari && indexData.orari.length > 1) {
                    const timeToDeleteFormatted = bookingTime.replace('-', ':');
                    const newOrari = indexData.orari.filter(t => t !== timeToDeleteFormatted);
                    updates[`${indexPath}/orari`] = newOrari;
                } else {
                    updates[indexPath] = null;
                }

                await database.ref().update(updates);

                const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbye8eB2g7m1OwRko81Qv849e4DeBZ5uH9aXEpuVO79JWT8ZXzt8EHGNf316pNBVeqt5/exec";
                const emailData = {
                    type: 'cancellation',
                    nome: userName,
                    email: userEmail,
                    data: bookingDate,
                    orari: bookingTime,
                    causale: reason
                };

                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(emailData), headers: { 'Content-Type': 'application/json' } })
                    .then(() => console.log("Richiesta di invio email di cancellazione partita."))
                    .catch(error => console.error("Errore script:", error));
                
                showNotification('Prenotazione cancellata e notifica inviata al cliente.');
                cancellationModal.style.display = 'none';

            } catch (error) {
                showNotification(`Errore durante la cancellazione: ${error.message}`, true);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Inizializzazione
        populateRecurringTimes();
        listenToRecurringBookings();
    });
    </script>
</body>
</html>
